<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Formula Source Loader</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #333;
      border-radius: 5px;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    pre {
      background: #252526;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      max-height: 300px;
    }
    h2 { color: #569cd6; }
    h3 { color: #4ec9b0; }
  </style>
</head>
<body>
  <h1>Formula Source Loader Test</h1>
  <div id="results"></div>

  <script type="module">
    import { enrichFormulasWithSource, getFormulaSource, getFullSDKSource } from './src/lib/formula-source-loader.ts';
    import { mockFormulas } from './src/constants/mockFormulas.ts';

    const resultsDiv = document.getElementById('results');

    function addSection(title, content, isSuccess = true) {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.innerHTML = `
        <h2>${title} <span class="${isSuccess ? 'success' : 'error'}">${isSuccess ? '✓' : '✗'}</span></h2>
        ${content}
      `;
      resultsDiv.appendChild(section);
    }

    // Test 1: Check if SDK source can be loaded
    try {
      const fullSource = getFullSDKSource();
      const hasContent = fullSource && fullSource.length > 0;
      addSection(
        'Test 1: Load Full SDK Source',
        `<p>Source length: ${fullSource.length} characters</p>
         <pre>${fullSource.substring(0, 500)}...</pre>`,
        hasContent
      );
    } catch (e) {
      addSection('Test 1: Load Full SDK Source', `<p class="error">Error: ${e.message}</p>`, false);
    }

    // Test 2: Extract individual formula source
    try {
      const fundingFeeSource = getFormulaSource('funding_fee');
      const hasSourceCode = fundingFeeSource.sourceCode && fundingFeeSource.sourceCode.length > 0;
      addSection(
        'Test 2: Extract Funding Fee Source',
        `<p>Has sourceCode: ${!!fundingFeeSource.sourceCode}</p>
         <p>Has formulaText: ${!!fundingFeeSource.formulaText}</p>
         ${fundingFeeSource.sourceCode ? `<pre>${fundingFeeSource.sourceCode}</pre>` : '<p class="error">No source code found</p>'}`,
        hasSourceCode
      );
    } catch (e) {
      addSection('Test 2: Extract Funding Fee Source', `<p class="error">Error: ${e.message}</p>`, false);
    }

    // Test 3: Enrich all formulas
    try {
      const enrichedFormulas = enrichFormulasWithSource(mockFormulas);
      const formulasWithSource = enrichedFormulas.filter(f => f.sourceCode);
      const successRate = (formulasWithSource.length / enrichedFormulas.length * 100).toFixed(1);
      
      let details = '<ul>';
      enrichedFormulas.forEach(f => {
        details += `<li>${f.id}: ${f.sourceCode ? '<span class="success">✓</span>' : '<span class="error">✗</span>'} (${f.sourceCode?.length || 0} chars)</li>`;
      });
      details += '</ul>';
      
      addSection(
        'Test 3: Enrich All Formulas',
        `<p>Total formulas: ${enrichedFormulas.length}</p>
         <p>Formulas with source: ${formulasWithSource.length} (${successRate}%)</p>
         ${details}`,
        formulasWithSource.length > 0
      );
    } catch (e) {
      addSection('Test 3: Enrich All Formulas', `<p class="error">Error: ${e.message}</p>`, false);
    }

    // Test 4: Check specific formulas
    const testFormulas = ['funding_fee', 'liquidation_price', 'pnl_calculation', 'order_fee', 'est_liq_price'];
    try {
      let details = '<ul>';
      let successCount = 0;
      
      testFormulas.forEach(id => {
        const source = getFormulaSource(id);
        const hasSource = !!source.sourceCode;
        if (hasSource) successCount++;
        details += `<li><strong>${id}</strong>: ${hasSource ? '<span class="success">✓ Found</span>' : '<span class="error">✗ Missing</span>'}</li>`;
      });
      details += '</ul>';
      
      addSection(
        'Test 4: Check Specific Formulas',
        `<p>Success: ${successCount}/${testFormulas.length}</p>${details}`,
        successCount === testFormulas.length
      );
    } catch (e) {
      addSection('Test 4: Check Specific Formulas', `<p class="error">Error: ${e.message}</p>`, false);
    }

    console.log('All tests completed!');
  </script>
</body>
</html>

