# ArrayNode.tsx Code Review & Optimization Recommendations

## 1. é‡å¤é€»è¾‘åˆ†æ (Duplicated Logic)

### ğŸ”´ ä¸¥é‡é‡å¤ï¼šç±»å‹è§„èŒƒåŒ–é€»è¾‘ (Type Normalization Logic)

**ä½ç½®ï¼š**

- `normalizeArrayValue` (lines 146-167, 193-214) - å¯¹è±¡å±æ€§å’ŒåŸå§‹æ•°ç»„çš„ç±»å‹è½¬æ¢
- `handleElementChange` (lines 393-414) - åŸå§‹æ•°ç»„å…ƒç´ çš„ç±»å‹è½¬æ¢
- `handleObjectPropertyChange` (lines 457-478) - å¯¹è±¡å±æ€§çš„ç±»å‹è½¬æ¢

**é—®é¢˜ï¼š** ç›¸åŒçš„ number/boolean/string è½¬æ¢é€»è¾‘é‡å¤äº† 3 æ¬¡ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦åŒæ­¥æ›´æ–°å¤šå¤„ã€‚

**å½±å“ï¼š**

- ç»´æŠ¤æˆæœ¬é«˜
- å®¹æ˜“å‡ºç°ä¸ä¸€è‡´çš„ bug
- ä»£ç å¯è¯»æ€§å·®

---

### ğŸ”´ ä¸¥é‡é‡å¤ï¼šupdateInput/updateInputAt é€‰æ‹©é€»è¾‘

**ä½ç½®ï¼š**

- Line 348: `const fn = data.id.includes(".") ? updateInputAt : updateInput;`
- Line 374: ç›¸åŒé€»è¾‘
- Line 421: ç›¸åŒé€»è¾‘
- Line 488: ç›¸åŒé€»è¾‘

**é—®é¢˜ï¼š** é‡å¤äº† 4 æ¬¡ï¼Œæ¯æ¬¡éƒ½éœ€è¦åˆ¤æ–­`data.id.includes(".")`

**å½±å“ï¼š**

- è¿å DRY åŸåˆ™
- å¦‚æœåˆ¤æ–­é€»è¾‘éœ€è¦ä¿®æ”¹ï¼Œéœ€è¦æ”¹ 4 å¤„

---

### ğŸŸ¡ ä¸­ç­‰é‡å¤ï¼šbaseElementType è®¡ç®—

**ä½ç½®ï¼š**

- Line 97-98: `const baseElementType = data.inputType || data.factorType?.baseType || "string";`
- Line 246-247: ç›¸åŒè®¡ç®—ï¼ˆå·² memoizeï¼Œä½†é€»è¾‘é‡å¤ï¼‰
- Line 389-390: åœ¨`handleElementChange`ä¸­é‡æ–°è®¡ç®—

**é—®é¢˜ï¼š** è™½ç„¶ Line 246-247 å·²ç» memoizeï¼Œä½† Line 389-390 åœ¨å›è°ƒä¸­é‡æ–°è®¡ç®—ï¼Œå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´ã€‚

---

### ğŸŸ¡ ä¸­ç­‰é‡å¤ï¼šé»˜è®¤å€¼ç”Ÿæˆé€»è¾‘

**ä½ç½®ï¼š**

- `normalizeArrayValue` (lines 130-142) - å¯¹è±¡å±æ€§çš„é»˜è®¤å€¼
- `handleAddElement` (lines 268-303, 315-331) - æ·»åŠ å…ƒç´ æ—¶çš„é»˜è®¤å€¼

**é—®é¢˜ï¼š** é€»è¾‘ç›¸ä¼¼ä½†ä¸å®Œå…¨ç›¸åŒï¼Œç­–ç•¥ä¸ä¸€è‡´ï¼š

- `normalizeArrayValue`ä½¿ç”¨ï¼š`prop.factorType.nullable ? null : 0` (line 132)
- `handleAddElement`ä½¿ç”¨ï¼š`propFactorType.constraints?.min ?? 0` (line 270)

**å½±å“ï¼š** å¯èƒ½å¯¼è‡´é»˜è®¤å€¼ä¸ä¸€è‡´çš„ bug

---

### ğŸŸ¡ ä¸­ç­‰é‡å¤ï¼šInput ç»„ä»¶çš„ value å’Œ onChange å¤„ç†

**ä½ç½®ï¼š**

- Lines 627-637, 638-659: å¯¹è±¡å±æ€§çš„ Input å¤„ç†
- Lines 698-708, 709-728: åŸå§‹æ•°ç»„å…ƒç´ çš„ Input å¤„ç†

**é—®é¢˜ï¼š** é€»è¾‘å‡ ä¹å®Œå…¨ç›¸åŒï¼Œä½†ä»£ç é‡å¤

---

## 2. ç›¸äº’å†²çªçš„é€»è¾‘ (Conflicting Logic)

### ğŸ”´ å†²çª 1ï¼šç©ºå­—ç¬¦ä¸²å¤„ç†ä¸ä¸€è‡´

**ä½ç½®ï¼š**

- `normalizeArrayValue` (line 171): å¯¹äºé nullable ç±»å‹ï¼Œç©ºå­—ç¬¦ä¸²ä¼šè¢«è·³è¿‡
- `normalizeArrayValue` (line 218): å¯¹äºé nullable ç±»å‹ï¼Œç©ºå­—ç¬¦ä¸²ä¹Ÿä¼šè¢«è·³è¿‡
- Input çš„ onChange (lines 645-648, 714-717): ç©ºå­—ç¬¦ä¸²ä¼šè¢«è½¬æ¢ä¸º null æˆ– 0

**é—®é¢˜ï¼š**

- åœ¨ normalize é˜¶æ®µï¼Œç©ºå­—ç¬¦ä¸²è¢«è¿‡æ»¤æ‰
- ä½†åœ¨ç”¨æˆ·è¾“å…¥æ—¶ï¼Œç©ºå­—ç¬¦ä¸²è¢«è½¬æ¢ä¸º null/0
- è¿™å¯èƒ½å¯¼è‡´ç”¨æˆ·è¾“å…¥çš„ç©ºå€¼åœ¨ normalize åè¢«ç§»é™¤ï¼Œé€ æˆå›°æƒ‘

**å»ºè®®ï¼š** ç»Ÿä¸€ç©ºå­—ç¬¦ä¸²çš„å¤„ç†ç­–ç•¥

---

### ğŸŸ¡ å†²çª 2ï¼šnull å€¼æ£€æŸ¥é‡å¤

**ä½ç½®ï¼š**

- Line 102: `if (item === null && !data.factorType?.nullable)`
- Line 189: `if (item === null && !data.factorType?.nullable)`

**é—®é¢˜ï¼š** åœ¨åŒä¸€ä¸ªå¾ªç¯ä¸­ï¼Œå¯¹åŸå§‹æ•°ç»„å…ƒç´ æ£€æŸ¥äº†ä¸¤æ¬¡ null å€¼ï¼ˆä¸€æ¬¡åœ¨ line 102ï¼Œä¸€æ¬¡åœ¨ line 189ï¼‰

**å½±å“ï¼š** è™½ç„¶ä¸ä¼šå¯¼è‡´é”™è¯¯ï¼Œä½†æ˜¯å†—ä½™çš„æ£€æŸ¥

---

### ğŸŸ¡ å†²çª 3ï¼šé»˜è®¤å€¼ç”Ÿæˆç­–ç•¥ä¸ä¸€è‡´

**ä½ç½®ï¼š**

- `normalizeArrayValue`: ä½¿ç”¨`prop.factorType.nullable ? null : 0` (line 132)
- `handleAddElement`: ä½¿ç”¨`propFactorType.constraints?.min ?? 0` (line 270)

**é—®é¢˜ï¼š**

- åœ¨ normalize æ—¶ï¼Œnumber ç±»å‹çš„é»˜è®¤å€¼æ˜¯ 0
- åœ¨æ·»åŠ å…ƒç´ æ—¶ï¼Œnumber ç±»å‹çš„é»˜è®¤å€¼æ˜¯`constraints?.min ?? 0`
- ç­–ç•¥ä¸ä¸€è‡´å¯èƒ½å¯¼è‡´è¡Œä¸ºå·®å¼‚

---

## 3. è®¾è®¡æ¨¡å¼ä¼˜åŒ–å»ºè®® (Design Pattern Improvements)

### âœ… å»ºè®® 1ï¼šæå–ç±»å‹è§„èŒƒåŒ–å·¥å…·å‡½æ•°

**å½“å‰é—®é¢˜ï¼š** ç±»å‹è½¬æ¢é€»è¾‘åˆ†æ•£åœ¨å¤šå¤„

**å»ºè®®ï¼š** åˆ›å»ºç»Ÿä¸€çš„ç±»å‹è§„èŒƒåŒ–å·¥å…·å‡½æ•°ï¼Œä½¿ç”¨ç­–ç•¥æ¨¡å¼

```typescript
// utils/valueNormalization.ts
export function normalizeValueByFactorType(
  value: unknown,
  factorType: FactorType
): unknown {
  // ç»Ÿä¸€çš„ç±»å‹è½¬æ¢é€»è¾‘
}
```

**å¥½å¤„ï¼š**

- å•ä¸€èŒè´£
- æ˜“äºæµ‹è¯•
- æ˜“äºç»´æŠ¤
- å¯åœ¨å…¶ä»–èŠ‚ç‚¹å¤ç”¨

---

### âœ… å»ºè®® 2ï¼šæå–é»˜è®¤å€¼ç”Ÿæˆå‡½æ•°

**å½“å‰é—®é¢˜ï¼š** é»˜è®¤å€¼ç”Ÿæˆé€»è¾‘é‡å¤ä¸”ä¸ä¸€è‡´

**å»ºè®®ï¼š** åˆ›å»ºç»Ÿä¸€çš„é»˜è®¤å€¼ç”Ÿæˆå‡½æ•°

```typescript
// utils/defaultValueGenerator.ts
export function getDefaultValueForFactorType(
  factorType: FactorType,
  property?: { default?: unknown }
): unknown {
  // ç»Ÿä¸€çš„é»˜è®¤å€¼ç”Ÿæˆé€»è¾‘
}
```

**å¥½å¤„ï¼š**

- ç»Ÿä¸€ç­–ç•¥
- æ˜“äºä¿®æ”¹é»˜è®¤å€¼è§„åˆ™
- å‡å°‘ bug

---

### âœ… å»ºè®® 3ï¼šæå–æ›´æ–°å‡½æ•°é€‰æ‹©å™¨

**å½“å‰é—®é¢˜ï¼š** `updateInput`/`updateInputAt`é€‰æ‹©é€»è¾‘é‡å¤

**å»ºè®®ï¼š** åˆ›å»º hook æˆ–å·¥å…·å‡½æ•°

```typescript
// hooks/useInputUpdater.ts
export function useInputUpdater(inputId: string) {
  const { updateInput, updateInputAt } = useFormulaStore();
  return useMemo(
    () => (inputId.includes(".") ? updateInputAt : updateInput),
    [inputId, updateInput, updateInputAt]
  );
}
```

**å¥½å¤„ï¼š**

- å‡å°‘é‡å¤ä»£ç 
- ç»Ÿä¸€æ›´æ–°é€»è¾‘
- æ˜“äºä¿®æ”¹

---

### âœ… å»ºè®® 4ï¼šæå– Input ç»„ä»¶æ¸²æŸ“é€»è¾‘

**å½“å‰é—®é¢˜ï¼š** Input ç»„ä»¶çš„ value å’Œ onChange å¤„ç†é‡å¤

**å»ºè®®ï¼š** åˆ›å»ºå¯å¤ç”¨çš„ Input æ¸²æŸ“ç»„ä»¶æˆ– hook

```typescript
// components/ArrayCellInput.tsx
export function ArrayCellInput({
  value,
  factorType,
  onChange,
  disabled,
}: ArrayCellInputProps) {
  // ç»Ÿä¸€çš„Inputæ¸²æŸ“é€»è¾‘
}
```

**å¥½å¤„ï¼š**

- å‡å°‘ä»£ç é‡å¤
- ç»Ÿä¸€ UI è¡Œä¸º
- æ˜“äºç»´æŠ¤

---

## 4. å…·ä½“ä¼˜åŒ–å»ºè®® (Specific Optimization Recommendations)

### ä¼˜å…ˆçº§ 1ï¼šé«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¼˜åŒ–ï¼‰

#### 1.1 æå–ç±»å‹è§„èŒƒåŒ–å‡½æ•°

- **æ–‡ä»¶ï¼š** `src/modules/formula-graph/utils/valueNormalization.ts`
- **å‡½æ•°ï¼š** `normalizeValueByFactorType(value, factorType)`
- **æ›¿æ¢ä½ç½®ï¼š**
  - `normalizeArrayValue`ä¸­çš„ç±»å‹è½¬æ¢é€»è¾‘
  - `handleElementChange`ä¸­çš„ç±»å‹è½¬æ¢é€»è¾‘
  - `handleObjectPropertyChange`ä¸­çš„ç±»å‹è½¬æ¢é€»è¾‘

#### 1.2 æå–æ›´æ–°å‡½æ•°é€‰æ‹©å™¨

- **æ–‡ä»¶ï¼š** `src/modules/formula-graph/hooks/useInputUpdater.ts`
- **Hookï¼š** `useInputUpdater(inputId)`
- **æ›¿æ¢ä½ç½®ï¼š** æ‰€æœ‰`const fn = data.id.includes(".") ? updateInputAt : updateInput;`

#### 1.3 ç»Ÿä¸€ç©ºå­—ç¬¦ä¸²å¤„ç†ç­–ç•¥

- **é—®é¢˜ï¼š** normalize é˜¶æ®µè¿‡æ»¤ç©ºå­—ç¬¦ä¸²ï¼Œä½†ç”¨æˆ·è¾“å…¥æ—¶è½¬æ¢ä¸º null/0
- **å»ºè®®ï¼š** åœ¨ normalize é˜¶æ®µä¿ç•™ç”¨æˆ·è¾“å…¥çš„ç©ºå­—ç¬¦ä¸²ï¼ˆè½¬æ¢ä¸º null/0ï¼‰ï¼Œåªåœ¨æœ€ç»ˆéªŒè¯æ—¶è¿‡æ»¤æ— æ•ˆå€¼

### ä¼˜å…ˆçº§ 2ï¼šä¸­ä¼˜å…ˆçº§ï¼ˆè¿‘æœŸä¼˜åŒ–ï¼‰

#### 2.1 æå–é»˜è®¤å€¼ç”Ÿæˆå‡½æ•°

- **æ–‡ä»¶ï¼š** `src/modules/formula-graph/utils/defaultValueGenerator.ts`
- **å‡½æ•°ï¼š** `getDefaultValueForFactorType(factorType, property?)`
- **ç»Ÿä¸€ç­–ç•¥ï¼š** ä¼˜å…ˆä½¿ç”¨`constraints?.min`ï¼Œå…¶æ¬¡ä½¿ç”¨`nullable ? null : typeDefault`

#### 2.2 æå– Input ç»„ä»¶æ¸²æŸ“é€»è¾‘

- **æ–‡ä»¶ï¼š** `src/modules/formula-graph/components/ArrayCellInput.tsx`
- **ç»„ä»¶ï¼š** `ArrayCellInput`
- **æ›¿æ¢ä½ç½®ï¼š** å¯¹è±¡å±æ€§å’ŒåŸå§‹æ•°ç»„å…ƒç´ çš„ Input æ¸²æŸ“

#### 2.3 ä¼˜åŒ– baseElementType ä½¿ç”¨

- **é—®é¢˜ï¼š** åœ¨`handleElementChange`ä¸­é‡æ–°è®¡ç®— baseElementType
- **å»ºè®®ï¼š** ä½¿ç”¨å·² memoize çš„`baseElementType`å˜é‡

### ä¼˜å…ˆçº§ 3ï¼šä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

#### 3.1 ä¼˜åŒ– normalizeArrayValue æ€§èƒ½

- **é—®é¢˜ï¼š** æ¯æ¬¡æ•°ç»„æ“ä½œéƒ½ä¼š normalize æ•´ä¸ªæ•°ç»„
- **å»ºè®®ï¼š** è€ƒè™‘å¢é‡ normalization æˆ– debounce

#### 3.2 æå–æ•°ç»„æ“ä½œé€»è¾‘

- **å»ºè®®ï¼š** åˆ›å»º`useArrayOperations` hookï¼Œç»Ÿä¸€ç®¡ç† add/remove/update æ“ä½œ

---

## 5. é‡æ„æ–¹å‘ (Refactoring Direction)

### é˜¶æ®µ 1ï¼šæå–å·¥å…·å‡½æ•°ï¼ˆ1-2 å¤©ï¼‰

1. åˆ›å»º`valueNormalization.ts` - ç±»å‹è§„èŒƒåŒ–
2. åˆ›å»º`defaultValueGenerator.ts` - é»˜è®¤å€¼ç”Ÿæˆ
3. åˆ›å»º`useInputUpdater.ts` - æ›´æ–°å‡½æ•°é€‰æ‹©å™¨
4. æ›¿æ¢æ‰€æœ‰é‡å¤é€»è¾‘

### é˜¶æ®µ 2ï¼šæå–ç»„ä»¶ï¼ˆ1 å¤©ï¼‰

1. åˆ›å»º`ArrayCellInput.tsx` - Input ç»„ä»¶
2. æ›¿æ¢é‡å¤çš„ Input æ¸²æŸ“é€»è¾‘

### é˜¶æ®µ 3ï¼šä¼˜åŒ–é€»è¾‘ï¼ˆ1 å¤©ï¼‰

1. ç»Ÿä¸€ç©ºå­—ç¬¦ä¸²å¤„ç†ç­–ç•¥
2. ä¼˜åŒ– baseElementType ä½¿ç”¨
3. ç§»é™¤é‡å¤çš„ null æ£€æŸ¥

### é˜¶æ®µ 4ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. ä¼˜åŒ– normalizeArrayValue æ€§èƒ½
2. æå–æ•°ç»„æ“ä½œ hook

---

## 6. ä»£ç è´¨é‡æŒ‡æ ‡

### å½“å‰çŠ¶æ€

- **ä»£ç è¡Œæ•°ï¼š** 796 è¡Œ
- **é‡å¤ä»£ç å—ï¼š** ~6 å¤„
- **å‡½æ•°å¤æ‚åº¦ï¼š** `normalizeArrayValue` - é«˜å¤æ‚åº¦ï¼ˆ~150 è¡Œï¼‰
- **å¯ç»´æŠ¤æ€§ï¼š** ä¸­ç­‰ï¼ˆå­˜åœ¨é‡å¤é€»è¾‘ï¼‰

### ä¼˜åŒ–åé¢„æœŸ

- **ä»£ç è¡Œæ•°ï¼š** ~600 è¡Œï¼ˆå‡å°‘~25%ï¼‰
- **é‡å¤ä»£ç å—ï¼š** 0 å¤„
- **å‡½æ•°å¤æ‚åº¦ï¼š** é™ä½ï¼ˆæ¯ä¸ªå‡½æ•°<50 è¡Œï¼‰
- **å¯ç»´æŠ¤æ€§ï¼š** é«˜ï¼ˆé€»è¾‘é›†ä¸­ï¼Œæ˜“äºä¿®æ”¹ï¼‰

---

## 7. é£é™©è¯„ä¼°

### ä½é£é™©

- æå–å·¥å…·å‡½æ•°ï¼ˆä¸æ”¹å˜ä¸šåŠ¡é€»è¾‘ï¼‰
- æå–ç»„ä»¶ï¼ˆåªæ”¹å˜ä»£ç ç»„ç»‡ï¼‰

### ä¸­é£é™©

- ç»Ÿä¸€ç©ºå­—ç¬¦ä¸²å¤„ç†ï¼ˆå¯èƒ½å½±å“ç°æœ‰è¡Œä¸ºï¼‰
- ç»Ÿä¸€é»˜è®¤å€¼ç­–ç•¥ï¼ˆå¯èƒ½æ”¹å˜é»˜è®¤å€¼ï¼‰

### å»ºè®®

- å…ˆè¿›è¡Œä½é£é™©é‡æ„
- å¯¹ä¸­é£é™©æ”¹åŠ¨è¿›è¡Œå……åˆ†æµ‹è¯•
- é€æ­¥é‡æ„ï¼Œä¸è¦ä¸€æ¬¡æ€§æ”¹åŠ¨å¤ªå¤š

---

## 8. æ€»ç»“

### ä¸»è¦é—®é¢˜

1. âœ… **ç±»å‹è§„èŒƒåŒ–é€»è¾‘é‡å¤** - éœ€è¦ç«‹å³æå–
2. âœ… **updateInput é€‰æ‹©é€»è¾‘é‡å¤** - éœ€è¦ç«‹å³æå–
3. âš ï¸ **ç©ºå­—ç¬¦ä¸²å¤„ç†ä¸ä¸€è‡´** - éœ€è¦ç»Ÿä¸€ç­–ç•¥
4. âš ï¸ **é»˜è®¤å€¼ç”Ÿæˆç­–ç•¥ä¸ä¸€è‡´** - éœ€è¦ç»Ÿä¸€

### ä¼˜åŒ–æ”¶ç›Š

- **å¯ç»´æŠ¤æ€§ï¼š** â¬†ï¸ æ˜¾è‘—æå‡ï¼ˆå‡å°‘é‡å¤ä»£ç ï¼‰
- **å¯è¯»æ€§ï¼š** â¬†ï¸ æå‡ï¼ˆé€»è¾‘æ›´æ¸…æ™°ï¼‰
- **å¯æ‰©å±•æ€§ï¼š** â¬†ï¸ æå‡ï¼ˆå·¥å…·å‡½æ•°å¯å¤ç”¨ï¼‰
- **æ€§èƒ½ï¼š** â¡ï¸ åŸºæœ¬ä¸å˜ï¼ˆå¯èƒ½ç•¥æœ‰æå‡ï¼‰

### å»ºè®®è¡ŒåŠ¨

1. **ç«‹å³å¼€å§‹ï¼š** æå–ç±»å‹è§„èŒƒåŒ–å‡½æ•°å’Œæ›´æ–°å‡½æ•°é€‰æ‹©å™¨
2. **æœ¬å‘¨å®Œæˆï¼š** æå– Input ç»„ä»¶å’Œç»Ÿä¸€å¤„ç†ç­–ç•¥
3. **åç»­ä¼˜åŒ–ï¼š** æ€§èƒ½ä¼˜åŒ–å’Œè¿›ä¸€æ­¥é‡æ„



