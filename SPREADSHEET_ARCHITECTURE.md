# Spreadsheet 组件架构图

## 组件层次结构

```
┌─────────────────────────────────────────────────────────────┐
│                    应用程序层                                  │
│  ┌──────────────────────┐  ┌──────────────────────────┐     │
│  │  Datasheet Mode      │  │  Playground/Dev Mode     │     │
│  └──────────┬───────────┘  └──────────┬───────────────┘     │
└─────────────┼──────────────────────────┼─────────────────────┘
              │                          │
              │                          │
┌─────────────▼──────────────┐  ┌────────▼──────────────────┐
│  SpreadsheetContainer      │  │  自定义实现                 │
│  ┌──────────────────────┐  │  │  ┌──────────────────────┐ │
│  │ useSpreadsheetState  │  │  │  │ 本地状态管理          │ │
│  ├──────────────────────┤  │  │  ├──────────────────────┤ │
│  │ useCalculation       │  │  │  │ useState, useRef     │ │
│  ├──────────────────────┤  │  │  ├──────────────────────┤ │
│  │ useActions           │  │  │  │ 自定义回调函数        │ │
│  ├──────────────────────┤  │  │  ├──────────────────────┤ │
│  │ useInitialization    │  │  │  │ GridStore 管理       │ │
│  └──────────────────────┘  │  │  └──────────────────────┘ │
│  连接全局 Store             │  │  独立状态管理             │
└─────────────┬──────────────┘  └────────┬──────────────────┘
              │                          │
              └──────────────┬───────────┘
                             │
                   传递 Props (数据 + 回调)
                             │
              ┌──────────────▼──────────────┐
              │   Spreadsheet (无状态)       │
              │  ┌────────────────────────┐ │
              │  │ SpreadsheetToolbar     │ │
              │  ├────────────────────────┤ │
              │  │ SpreadsheetHeader      │ │
              │  ├────────────────────────┤ │
              │  │ SpreadsheetRow         │ │
              │  │   └─ Cell Components   │ │
              │  └────────────────────────┘ │
              │  纯展示组件 (Pure UI)        │
              └─────────────────────────────┘
```

## 数据流向

```
┌─────────────────────────────────────────────────────────────┐
│                       全局状态 Store                          │
│  ┌─────────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ SpreadsheetStore│  │  GridStore   │  │ Developer    │   │
│  │ (UI 状态)       │  │  (单元格数据) │  │ Store        │   │
│  └─────────────────┘  └──────────────┘  └──────────────┘   │
└───────────┬─────────────────────────────────────────────────┘
            │ (Datasheet 模式)
            │
            ▼
┌───────────────────────────────────────────────────────────┐
│              SpreadsheetContainer                         │
│                                                           │
│  数据流：Store → Hooks → Props                             │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. 从 Store 读取状态                                  │ │
│  │ 2. 使用 Hooks 处理业务逻辑                            │ │
│  │ 3. 组装 Props 传递给 Spreadsheet                      │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  回调流：Spreadsheet → Handlers → Store                    │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 1. 用户交互触发回调                                    │ │
│  │ 2. Handler 处理业务逻辑                               │ │
│  │ 3. 更新 Store 状态                                    │ │
│  └─────────────────────────────────────────────────────┘ │
└───────────┬───────────────────────────────────────────────┘
            │
            │ Props (纯数据 + 回调函数)
            │
            ▼
┌───────────────────────────────────────────────────────────┐
│              Spreadsheet (无状态组件)                       │
│                                                           │
│  接收：                                                    │
│  - columns, rowIds, gridStore                            │
│  - selection, selectedRowIds, selectedColIds             │
│  - 各种回调函数 (onRowClick, onCellClick, etc.)          │
│                                                           │
│  渲染：                                                    │
│  - 工具栏 (Toolbar)                                       │
│  - 表头 (Header)                                          │
│  - 数据行 (Rows) - 虚拟滚动                               │
│  - 单元格 (Cells)                                        │
│                                                           │
│  不依赖：                                                  │
│  - 全局 Store ✗                                          │
│  - 业务逻辑 ✗                                            │
│  - 状态管理 ✗                                            │
└───────────────────────────────────────────────────────────┘
```

## Playground/Development 模式数据流

```
┌───────────────────────────────────────────────────────────┐
│              自定义状态管理 (本地)                           │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ useState<ColumnDef[]>                               │ │
│  │ useState<RowDef[]>                                  │ │
│  │ useState<Selection>                                 │ │
│  │ useRef<GridStore>                                   │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                           │
│  自定义回调函数：                                           │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ handleAddRow()                                      │ │
│  │ handleDeleteColumn()                                │ │
│  │ handleCellClick()                                   │ │
│  │ ... 等等                                            │ │
│  └─────────────────────────────────────────────────────┘ │
└───────────┬───────────────────────────────────────────────┘
            │
            │ Props (完全自定义)
            │
            ▼
┌───────────────────────────────────────────────────────────┐
│              Spreadsheet (无状态组件)                       │
│  相同的组件，不同的数据源！                                  │
└───────────────────────────────────────────────────────────┘
```

## 关键优势

### 1. 单一职责原则

- **Spreadsheet**: 只负责渲染
- **SpreadsheetContainer**: 只负责状态管理
- **Hooks**: 各自处理特定逻辑

### 2. 开闭原则

- 对扩展开放：可以创建新的容器组件
- 对修改关闭：无状态组件不需要修改

### 3. 依赖倒置

- 高层模块（Spreadsheet）不依赖低层模块（Store）
- 两者都依赖抽象（Props 接口）

### 4. 可测试性

```
┌─────────────────────────────────────┐
│  测试 Spreadsheet                   │
│  ✓ 传入 mock props                  │
│  ✓ 验证渲染输出                     │
│  ✓ 模拟用户交互                     │
│  ✓ 检查回调被调用                   │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  测试 SpreadsheetContainer          │
│  ✓ Mock Store                       │
│  ✓ 验证 hooks 调用                  │
│  ✓ 检查 props 正确传递              │
└─────────────────────────────────────┘
```

## 迁移路径

```
旧实现 (耦合)
┌────────────────────────┐
│  Spreadsheet           │
│  - 直接使用 Store      │
│  - 内部状态管理        │
│  - 混合业务逻辑和 UI   │
└────────────────────────┘
        │
        │ 重构
        ▼
新实现 (解耦)
┌────────────────────────┐
│  SpreadsheetContainer  │
│  - 状态管理层          │
│  - 连接 Store          │
└──────────┬─────────────┘
           │
           ▼
┌────────────────────────┐
│  Spreadsheet           │
│  - 纯展示层            │
│  - 接收 Props          │
│  - 可复用              │
└────────────────────────┘
```
